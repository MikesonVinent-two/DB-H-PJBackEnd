-- 数据库迁移脚本：将评测配置从ANSWER_GENERATION_BATCHES移到EVALUATION_RUNS
-- 作者：[您的名字]
-- 创建日期：[当前日期]

-- 开始事务
START TRANSACTION;

-- 1. 备份当前数据
CREATE TEMPORARY TABLE IF NOT EXISTS `TEMP_BATCH_EVAL_CONFIG` (
    `BATCH_ID` BIGINT,
    `EVALUATION_ASSEMBLY_CONFIG_ID` BIGINT
);

INSERT INTO `TEMP_BATCH_EVAL_CONFIG` (
    `BATCH_ID`,
    `EVALUATION_ASSEMBLY_CONFIG_ID`
)
SELECT 
    `ID`,
    `EVALUATION_ASSEMBLY_CONFIG_ID`
FROM 
    `ANSWER_GENERATION_BATCHES`
WHERE 
    `EVALUATION_ASSEMBLY_CONFIG_ID` IS NOT NULL;

-- 2. 在EVALUATION_RUNS表中添加新字段
ALTER TABLE `EVALUATION_RUNS`
ADD COLUMN `EVALUATION_ASSEMBLY_CONFIG_ID` BIGINT NULL COMMENT '评测阶段使用的prompt组装配置' AFTER `PARAMETERS`,
ADD COLUMN `SUBJECTIVE_PROMPT_ID` BIGINT NULL COMMENT '主观题评测prompt ID' AFTER `EVALUATION_ASSEMBLY_CONFIG_ID`;

-- 3. 添加外键约束
ALTER TABLE `EVALUATION_RUNS`
ADD CONSTRAINT `FK_EVALUATION_RUNS_CONFIG` FOREIGN KEY (`EVALUATION_ASSEMBLY_CONFIG_ID`) 
    REFERENCES `EVALUATION_PROMPT_ASSEMBLY_CONFIGS`(`ID`) ON DELETE SET NULL,
ADD CONSTRAINT `FK_EVALUATION_RUNS_SUBJ_PROMPT` FOREIGN KEY (`SUBJECTIVE_PROMPT_ID`) 
    REFERENCES `EVALUATION_SUBJECTIVE_PROMPTS`(`ID`) ON DELETE SET NULL;

-- 4. 迁移数据：将批次的评测配置复制到关联的评测运行中
UPDATE `EVALUATION_RUNS` er
JOIN `TEMP_BATCH_EVAL_CONFIG` temp ON er.`MODEL_ANSWER_RUN_ID` IN (
    SELECT mar.`ID` 
    FROM `MODEL_ANSWER_RUNS` mar 
    WHERE mar.`ANSWER_GENERATION_BATCH_ID` = temp.`BATCH_ID`
)
SET er.`EVALUATION_ASSEMBLY_CONFIG_ID` = temp.`EVALUATION_ASSEMBLY_CONFIG_ID`;

-- 5. 从ANSWER_GENERATION_BATCHES表中移除EVALUATION_ASSEMBLY_CONFIG_ID字段
-- 首先删除外键约束（如果存在）
SET @constraint_name = (
    SELECT CONSTRAINT_NAME 
    FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
    WHERE TABLE_NAME = 'ANSWER_GENERATION_BATCHES' 
    AND COLUMN_NAME = 'EVALUATION_ASSEMBLY_CONFIG_ID' 
    AND CONSTRAINT_SCHEMA = DATABASE()
    AND REFERENCED_TABLE_NAME = 'EVALUATION_PROMPT_ASSEMBLY_CONFIGS'
);

SET @sql = IF(@constraint_name IS NOT NULL, 
    CONCAT('ALTER TABLE `ANSWER_GENERATION_BATCHES` DROP FOREIGN KEY ', @constraint_name),
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- 然后删除列
ALTER TABLE `ANSWER_GENERATION_BATCHES` 
DROP COLUMN `EVALUATION_ASSEMBLY_CONFIG_ID`;

-- 6. 清理临时表
DROP TEMPORARY TABLE IF EXISTS `TEMP_BATCH_EVAL_CONFIG`;

-- 提交事务
COMMIT;

-- 验证更改
SELECT 
    'EVALUATION_RUNS表中EVALUATION_ASSEMBLY_CONFIG_ID字段添加成功' AS 'Migration Status'
FROM 
    INFORMATION_SCHEMA.COLUMNS 
WHERE 
    TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'EVALUATION_RUNS' 
    AND COLUMN_NAME = 'EVALUATION_ASSEMBLY_CONFIG_ID';

SELECT 
    'EVALUATION_RUNS表中SUBJECTIVE_PROMPT_ID字段添加成功' AS 'Migration Status'
FROM 
    INFORMATION_SCHEMA.COLUMNS 
WHERE 
    TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'EVALUATION_RUNS' 
    AND COLUMN_NAME = 'SUBJECTIVE_PROMPT_ID';

SELECT 
    'ANSWER_GENERATION_BATCHES表中EVALUATION_ASSEMBLY_CONFIG_ID字段删除成功' AS 'Migration Status'
FROM 
    INFORMATION_SCHEMA.COLUMNS 
WHERE 
    TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'ANSWER_GENERATION_BATCHES' 
    AND COLUMN_NAME = 'EVALUATION_ASSEMBLY_CONFIG_ID'
HAVING 
    COUNT(*) = 0; 